schema_version: 1

params:
  cond_proprio_dim: 62
  cond_proprio_seq: 40
  cond_visual_dim: 1072
  cond_visual_frames: 2
  cond_visual_tokens: 3
  action_dim: 24
  action_seq: 40

  transformer_d_model: 384
  transformer_nhead: 16
  transformer_dim_feedforward: 2048
  transformer_dropout: 0.2
  transformer_activation: gelu
  transformer_batch_first: true
  transformer_is_causal: false
  transformer_tgt_is_causal: true
  transformer_num_layers: 12

  posterior_num_tokens: 300
  info_num_tokens: 300
  action_chunk_size: 40

model:
  graph:
    inputs: [cond_proprio, cond_visual, action, time, noise]
    modules:
      vqvae_posterior:
        _type_: cfg_vqvae_posterior
        cond_proprio_dim: ${params.cond_proprio_dim}
        cond_visual_dim: ${params.cond_visual_dim}
        transformer_d_model: ${params.transformer_d_model}
        transformer_nhead: ${params.transformer_nhead}
        transformer_dim_feedforward: ${params.transformer_dim_feedforward}
        transformer_dropout: ${params.transformer_dropout}
        transformer_activation: ${params.transformer_activation}
        transformer_batch_first: ${params.transformer_batch_first}
        transformer_is_causal: ${params.transformer_is_causal}
        transformer_num_layers: ${params.transformer_num_layers}
        transformer_num_tokens: ${params.posterior_num_tokens}
        action_dim: ${params.action_dim}
        use_cond_semantic: false
        use_cond_semantic_projection: false
        cond_semantic_dim: null
      info_encoder:
        _type_: cfg_vqvae_info_encoder
        cond_proprio_dim: ${params.cond_proprio_dim}
        cond_visual_dim: ${params.cond_visual_dim}
        transformer_d_model: ${params.transformer_d_model}
        transformer_nhead: ${params.transformer_nhead}
        transformer_dim_feedforward: ${params.transformer_dim_feedforward}
        transformer_dropout: ${params.transformer_dropout}
        transformer_activation: ${params.transformer_activation}
        transformer_batch_first: ${params.transformer_batch_first}
        transformer_is_causal: ${params.transformer_is_causal}
        transformer_num_layers: ${params.transformer_num_layers}
        transformer_num_tokens: ${params.info_num_tokens}
        use_cond_semantic: true
        cond_semantic_dim: ${params.transformer_d_model}
      action_decoder:
        _type_: cfg_vqvae_action_decoder
        action_dim: ${params.action_dim}
        transformer_d_model: ${params.transformer_d_model}
        transformer_nhead: ${params.transformer_nhead}
        transformer_dim_feedforward: ${params.transformer_dim_feedforward}
        transformer_dropout: ${params.transformer_dropout}
        transformer_activation: ${params.transformer_activation}
        transformer_batch_first: ${params.transformer_batch_first}
        transformer_tgt_is_causal: ${params.transformer_tgt_is_causal}
        transformer_num_layers: ${params.transformer_num_layers}
        transformer_action_chunk_size: ${params.action_chunk_size}
        use_cond_semantic_projection: false
        use_cond_semantic: true
        cond_semantic_dim: ${params.transformer_d_model}
    nodes:
      - name: posterior_semantic
        call: module:vqvae_posterior
        kwargs:
          cond_proprio: $cond_proprio
          cond_visual: $cond_visual
          action: $action
      - name: conditioning_info
        call: module:info_encoder
        kwargs:
          cond_proprio: $cond_proprio
          cond_visual: $cond_visual
          cond_semantic: $posterior_semantic
      - name: decoded_action
        call: module:action_decoder
        kwargs:
          time: $time
          noise: $noise
          memory_input: $conditioning_info
          discrete_semantic_input: $posterior_semantic
    outputs: [$decoded_action]
    return: single
